## 0. Install debian

- Use image without firmware
- Install GNOME (for SafeNet)

## 1. Configure EasyRSA and create certificates (debian)

Quote:
https://docs.bigchaindb.com/projects/server/en/v1.3.0/production-deployment-template/client-tls-certificate.html

Install easyrsa on Debian
`sudo apt install easyrsa`
OR
`sudo apt install easy-rsa`

The binary `easyrsa` can be found in
`/usr/share/easy-rsa`

---
1.1 Init CA
`sudo ./easyrsa init-pki`
`sudo ./easyrsa build-ca nopass`

---
1.2 **Create a certificate request:**

`sudo ./easyrsa gen-req NAME nopass`
This will create
`/usr/share/easy-rsa/pki/reqs/NAME.req`
`/usr/share/easy-rsa/pki/private/NAME.key`

ALTERNATIVELY: import an external request:
`sudo ./easyrsa import-req /path/to/NAME.req NAME`

---
then sign a cert
`./easyrsa sign-req client NAME`

---
As a result, a certificate will be created at:
`/usr/share/easy-rsa/pki/issued/NAME.crt`

Once you have signed it, you can send the signed certificate and the CA certificate back to the requestor.
(CA certificate is `pki/ca.crt`)

---
1.3 create pem
`cat pki/issued/NAME.crt pki/private/NAME.key > NAME.pem`

---
1.4 create pfx
`openssl pkcs12 -export -out NAME.pfx -inkey pki/private/NAME.key -in pki/issued/NAME.crt`

---
1.5 create pub for ssh
`ssh-keygen -f NAME.pem -y > NAME.pub`


## 2. Install Safe Net Authentication client

#### Important: token passwords in Mac version and Linux version are not fully compatible. I've tested alphanumeric and it works fine, however a symbol like `#` causes issues and passwords won't work on either Linux or MacOS.

### Mac
https://www.certsign.ro/en/support/safenet-installing-the-device-on-macos/
Version for BigSur: [here](http://support.certsign.ro/safenet/SafeNetAuthenticationClient.10.2.111.0.dmg)

Quote:
[SafeNet Authentication Client_9.0_Users_Guide.pdf](https://knowledge.digicert.com/content/dam/digicertknowledgebase/attachment/solution/SO28683/SafeNet%20Authentication%20Client_9.0_Users_Guide.pdf)

Importing a Certificate to a Token 
The following certificate types are supported:  
- *.pfx 
- *.p12 
- *.cer

I.e. ***.pem is NOT supported.**

### Ubuntu 20

Download the client here: 
https://knowledge.digicert.com/generalinformation/INFO1982.html
Linux  
[https://www.digicert.com/StaticFiles/SAC_10_7_Linux_GA.zip](https://www.digicert.com/StaticFiles/SAC_10_7_Linux_GA.zip)

run
`sudo apt upgrade`
`sudo apt update`

run `dpkg -i Installation/Standard/DEB/safenetauthenticationclient_...deb`
then restart

### Debian

- Same as Ubuntu
- make sure root's path has
`echo "export PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin" >> ~/.bashrc`
- make sure easy-rsa is installed (step 1), it has some dependencies needed for the client to work.
- Use GNOME
- restart after install

## 3. SSH Cert

Quote:
https://security.stackexchange.com/questions/32768/converting-keys-between-openssl-and-openssh
SSH uses its own public key format.

If you just want to share the private key, the OpenSSL key generated by your example command is stored in `private.pem`, and it should already be in PEM format compatible with (recent) OpenSSH. To extract an OpenSSH compatible public key from it, you can just run the following command:

3.1 Create ssh public key out of pem file
```
ssh-keygen -f NAME.pem -y > NAME.pub
```

## 4. Connecting via SSH to AWS servers

Importing a public ssh key is done by creating a key pair on AWS side (via browser or client).
In browser: - `Network & Security` -> `Key Pairs` -> `Actions` -> `Import key pair`
Client help here:
https://docs.aws.amazon.com/cli/latest/reference/ec2/import-key-pair.html


### Route 1: simple ssh-keygen (UNUSED, just for the reference)

`ssh-keygen -t rsa -C "my-key" -f my-key`
This will create `my-key` and `my-key.pub`.


* to connect to Amazon Linux on AWS - use user **ec2-user**:
`ssh -i my-key ec2-user@HOSTNAME`

* to connect to Ubuntu Linux on AWS - use user **admin**:
`ssh -i my-key admin@HOSTNAME`


### Route 2: easyrsa + pem certificate

- Create certificates (1.1), create *pem (1.2)
- Create and import public key to create a key pair on AWS side (see 3.1).
- login like this:
	`ssh -i NAME.pem ec2-user@HOSTNAME`


### Route 3: and the most important one - SSH with Safe Net token
Install a good SafeNet Authentication client (2).

#### Important: token passwords in Mac version and Linux version are not fully compatible. I've tested alphanumeric and it works fine, however a symbol like `#` causes issues and passwords won't work on either Linux or MacOS.

Install a pfx certificate from (1.3) on SafeNet Token.
Pretty straightforward via GUI client (import certificate).


Use the following command to log in to the same server for **Route 2** with eToken:
MacOS (tested on BigSur + SAC 10.2): 
`ssh -I /usr/local/lib/libeToken.dylib ec2-user@HOSTNAME`
Linux (tested on Ubuntu + SAC 10.7):
`ssh -I /usr/lib/libeToken.so ec2-user@HOSTNAME`
SFTP (untested):
`sftp -o "SmartcardDevice=/usr/lib/libeToken.so" user@example.com`

Example successful connection output on MacOS (for the reference):
```
john@MacBook-Pro certs % ssh -I /usr/local/lib/libeToken.dylib ec2-user@ec2-3-95-176-151.compute-1.amazonaws.com
Enter PIN for 'token2':
Last login: Sun Oct 30 06:01:28 2022 from 173.239.197.56
  
 __|  __|_  )
 _|  (     /    Amazon Linux 2 AMI
___|\___|___|
  
https://aws.amazon.com/amazon-linux-2/
13 package(s) needed for security, out of 16 available
Run "sudo yum update" to apply all updates.
[ec2-user@ip-172-31-82-206 ~]$
```

#### Multiple certificates:
Multiple certificates are supported on the token and can be used for different servers; apparently they are somehow automatically matched automatically by ssh client / pkcs11.

CONFUSING: Please note, that in case there is no matching certificate found, the connection will fail with Permission Denied, and it won't ask a token pin, which might look like the token doesn't work properly.
```
john@MacBook-Pro certs % ssh -I /usr/local/lib/libeToken.dylib ec2-user@ec2-35-175-244-208.compute-1.amazonaws.com
ec2-user@ec2-35-175-244-208.compute-1.amazonaws.com: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).
```

## 5. Secure delete everything except for public keys

Quote:
https://www.groovypost.com/howto/securely-delete-files-in-linux/

### secure-delete
`sudo apt-get install secure-delete`
`sudo srm delete-this-file.txt`

### wipe
`sudo apt-get install wipe`
`wipe /home/lori/Documents/delete-this-file.txt`


## 6. Create your own ssh server and add public key to ssh, prohibit login/password entry

Quote:
https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server

### Copying an SSH Public Key to Your Server

The content of your  `id_rsa.pub`  file will have to be added to a file at  `~/.ssh/authorized_keys`  on your remote machine somehow.

Make sure the `~/.ssh` directory is created:
`mkdir -p ~/.ssh`

Create or modify the `authorized_keys` file:
`echo PUBLIC_KEY_STR >> ~/.ssh/authorized_keys`

In the above command, substitute the `PUBLIC_KEY_STR` with the output from the `cat ~/.ssh/id_rsa.pub` command that you executed on your local system. It should start with `ssh-rsa AAAA...` or similar.

### Quick method

`cat id_rsa.pub | ssh username@remote_host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"`

### Disabling Password Authentication on your Server

- `sudo nano /etc/ssh/sshd_config`
- update contents: `PasswordAuthentication no`
- `sudo systemctl restart ssh`

### Log In
`ssh -I /usr/lib/libeToken.so IP_ADDR`
`ssh -I /usr/local/lib/libeToken.dylib IP_ADDR`